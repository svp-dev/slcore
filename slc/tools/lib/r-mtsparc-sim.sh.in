#! /bin/sh
# $Id$
set -eu
MGSIM_SPARC=${MGSIM_SPARC:-@MGSIM_SPARC@}
basename=${0##*/}
program=${1:?}
datafile=${2:?}
fdatafile=${3:?}
DEBUGGER=${DEBUGGER:-gdb --args}
if test -n "${DEBUG:-}"; then
   MGSIM_SPARC="$MGSIM_SPARC.dbg"
fi
if test -n "${SIMGFX:-}"; then
   MGSIM_SPARC="$MGSIM_SPARC.gfx"
fi
shift
shift
shift
if ! test -x "$program"; then
    echo "$basename: $program: not an executable" >&2
    exit 1
fi
if ! test -r "$datafile"; then
    echo "$basename: $datafile: file not found or not readable" >&2
    exit 1
fi

if ! test -r "$fdatafile"; then
    echo "$basename: $fdatafile: file not found or not readable" >&2
    exit 1
fi

if ! "$MGSIM_SPARC" --help >/dev/null 2>&1; then
  echo "$basename: cannot find simulator (MGSIM_SPARC=$MGSIM_SPARC)." >&2
  exit 1
fi

if test -n "${NCORES:-}"; then
   SIMARGS="-o NumProcessors=$NCORES ${SIMARGS:-}"
fi

do_debug=
if test -n "${DEBUG:-}"; then
   SIMARGS="-i ${SIMARGS:-}"
   do_debug=$DEBUGGER
fi
if test -n "${VERBOSE:-}"; then
   echo "$basename: running: ${RUNNER_PREFIX:-} $do_debug $MGSIM_SPARC ${SIMARGS:-} -t ${*:-} -L16 $datafile -L17 $fdatafile $program" >&2
fi  
exec ${RUNNER_PREFIX:-} $do_debug $MGSIM_SPARC ${SIMARGS:-} -t ${1:+"$@"} -L16 "$datafile" -L17 "$fdatafile" "$program"
