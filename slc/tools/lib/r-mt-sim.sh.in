#! /bin/sh
set -eu
basename=${0##*/}
program=${1:?}
datafile=${2:?}
fdatafile=${3:?}
shift
shift
shift

slc_datadir=${SLC_DATADIR:-@slc_datadir@}
DEBUGGER=${DEBUGGER:-gdb --args}
SIMARGS=${SIMARGS:-}
mgsim=(${MGSIM_@ARCH@:-@MGSIM_ARCH@})
simx=(${SIMX_@ARCH@:-@SIMX_ARCH@})
simargs_base=()

##
## Selection of the number of cores
##

if test -n "${SLR_RECURSIVE:-}"; then
  SIMPROFILE=simple
  simargs_base+=(-q)
fi

saveIFS=$IFS
IFS=:
found=
if test "x$SIMPROFILE" = "xlist"; then
  echo "$basename: available profiles:" >&2
  echo "(in $HOME/.mt-profiles)" >&2
  for f in "$HOME/.mt-profiles/"*; do
      if test -r "$f"; then
          b=$(basename "$f")
          if test -L "$f"; then
              printf '\t%s\t' "$b"; file -h "$f"|cut -d: -f2
          else
              . "$f"
              printf '\t%s\t %s\n' "$b" "$DESCRIPTION" >&2
          fi
      fi
  done
  for d in $slc_datadir; do
    echo "(in $d)" >&2
    for f in "$d/mt-profiles/"*; do
        if test -r "$f"; then
            b=$(basename "$f")
            if test -L "$f"; then
                printf '\t%s\t' "$b"; file -h "$f"|cut -d: -f2
            else
                . "$f"
                printf '\t%s\t %s\n' "$b" "$DESCRIPTION" >&2
            fi
        fi
    done     
  done
  exit 0
fi

for d in "$HOME/.mt-profiles" $slc_datadir; do
   pf="$d/mt-profiles/$SIMPROFILE"
   if test -r "$pf"; then
      . "$d/mt-profiles/$SIMPROFILE"
      if test -n "$VERBOSE"; then
         echo "$basename: using profile: $pf" >&2
         echo "$basename: profile description: $DESCRIPTION" >&2
      fi
      found=1
      break
   fi
done
IFS=$saveIFS
if test -z "$found"; then
   echo "$basename: profile '$SIMPROFILE' not found." >&2
   exit 1
fi

if test -n "${ncores_override:-}"; then
   NCORES=$ncores_override
fi

if test -n "${NCORES:-}"; then
   simargs_base+=(-o NumProcessors=$NCORES)
fi

##
## Selection of the memory system
##

if test -n "${COMA:-}"; then
    thesim=$simx
    if test -n "${coma_ncaches:-}"; then
	simargs_base+=(-o NumCaches=$coma_ncaches)
    fi
    if test -n "${coma_ndirs:-}"; then
	simargs_base+=(-o NumDirectories=$coma_ndirs)
    fi
else
    thesim=$mgsim
fi
if ! "${thesim[@]}" --help >/dev/null 2>&1; then
  echo "$basename: cannot find simulator (${thesim[*]})." >&2
  exit 1
fi

##
## Selection of debugging 
##

do_debug=
if test -n "${DEBUG:-}"; then
    simargs_base+=(-i)
    do_debug=$DEBUGGER
    if ! test -x "${thesim[0]}.dbg"; then
	echo "$basename: warning: ${thesim[0]}.dbg not found, using ${thesim[0]} instead." >&2
    else
	thesim[0]=${thesim[0]}.dbg
    fi
fi

##
## Selection of graphical output
##

if test -n "${SIMGFX:-}"; then
    if ! test -x "${thesim[0]}.gfx"; then
	echo "$basename: warning: ${thesim[0]}.gfx not found, disabling graphical output." >&2
    else    
	thesim[0]=${thesim[0]}.gfx
	simargs_base+=(-o GfxEnableOutput=true)
	if test -n "${gfx_scale:-}"; then
	    simargs_base+=(-o GfxHorizScale=${gfx_scale%,*} -o GfxVertScale=${gfx_scale#*,})
	fi
	if test -n "${gfx_geometry:-}"; then
	    simargs_base+=(-o GfxDisplayWidth=${gfx_geometry%,*} -o GfxDisplayHeight=${gfx_geometry#*,})
	fi
	if test -n "${gfx_refresh:-}"; then
	    simargs_base+=(-o GfxRefreshDelay=$gfx_refresh)
	fi
    fi
fi

if test -n "${VERBOSE:-}"; then
    echo "$basename: running: ${RUNNER_PREFIX:-} $do_debug ${thesim[*]} ${simargs_base[*]} ${SIMARGS:-} -t -L16 $datafile -L17 $fdatafile ${*:-} $program" >&2
fi  
exec ${RUNNER_PREFIX:-} $do_debug "${thesim[@]}" "${simargs_base[@]}" ${SIMARGS:-} -t -L16 "$datafile" -L17 "$fdatafile" ${1:+"$@"} "$program"
