#! @BASH@
set -e
prefix=$(dirname "$0")
prefix=$(cd "$prefix"; pwd)

case $1 in
  -h|--help)
	cat >&2 <<EOF
Usage: $0
   or: $0 [TAG]
   or: $0 [SL-REQS-DIR] [SL-DIR]

Display environment variables settings for use with a specified SL
environment. If no arguments are provided, an interactive selection is
proposed.

Recommended use in a shell: 

   eval \$($0 ...)
EOF
	exit 0
	;;
esac

cd "$prefix"

if test $# -ge 2; then
  tag=
  case $1 in
    slreqs-*) slreq_sel=$1 ;;
    *)        slreq_sel=slreqs-$1 ;;
  esac
  case $2 in
    sl-*)    sl_sel=$2 ;; 
    *)       sl_sel=sl-$2 ;;
  esac
else
  if test $# -ge 1; then
     tag=$1
  else
     cat >&2 <<EOF

   Welcome to the SL toolchain selection tool!

Multiple versions of the toolchain and its dependencies are installed
on this system. 

Select the installation tag:
EOF
    select tag in $(cd tags && echo *); do
       if test -n "$tag"; then break; fi
    done
  fi
  slreq_sel=slreqs-`grep reqtag <tags/"$tag"|cut -d: -f2-`
  sl_sel=sl-`grep sltag <tags/"$tag"|cut -d: -f2-`
fi

if ! test -d $slreq_sel/; then
  echo "Invalid dependency specifier: $slreq_sel" >&2
  exit 1
fi

if ! test -d $sl_sel/; then
  echo "Invalid SL toolchain specifier: $sl_sel" >&2
  exit 1
fi

echo >&2
echo >&2
echo "Next time the following command can be used:" >&2

if test -n "$tag"; then
   echo "   $0 $tag" >&2
else
   echo"    $0 $slreq_sel $sl_sel" >&2
fi
echo >&2

slreq_base=$prefix/$slreq_sel
sl_base=$prefix/$sl_sel

cat <<EOF
: The command-lines to set up environment variables is printed below;
: for maximum comfort run this script with "eval" in a shell; 
EOF

if test -r slenv_local; then cat slenv_local; fi

cat <<EOF
: Tool locations ;
export SL_TAG=$sl_sel;
export SLREQS_TAG=$slreq_sel;
export PYTHONPATH=$sl_base/lib/sl-core:$sl_base/lib/python2.6/site-packages;
export PATH=$sl_base/bin:$slreq_base/bin:\$PATH;
export MANPATH=$sl_base/share/man:$slreq_base/share/man:\$MANPATH;
export CC_ALPHA_OVERRIDE=$slreq_base/bin/alpha-linux-gnu-gcc;
export UTCC_ALPHA_OVERRIDE=$slreq_base/bin/mtalpha-linux-gnu-gcc;
export AR_MTALPHA_OVERRIDE=$slreq_base/bin/mtalpha-linux-gnu-ar;
export RANLIB_MTALPHA_OVERRIDE=$slreq_base/bin/mtalpha-linux-gnu-ranlib;
export CC_SPARC_OVERRIDE=$slreq_base/bin/sparc-leon-linux-gcc;
export UTCC_SPARC_OVERRIDE=$slreq_base/bin/mtsparc-leon-linux-gcc;
export AR_MTSPARC_OVERRIDE=$slreq_base/bin/mtsparc-leon-linux-ar;
export RANLIB_MTSPARC_OVERRIDE=$slreq_base/bin/mtsparc-leon-linux-ranlib
EOF

